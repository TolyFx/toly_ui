class TableDemo7 extends StatefulWidget {
  const TableDemo7({super.key});

  @override
  State<TableDemo7> createState() => _TableDemo7State();
}

class _TableDemo7State extends State<TableDemo7> {
  List<int> _selectedKeys = [];
  int _currentPage = 1;
  final int _pageSize = 8;

  // 生成综合测试数据
  List<ComprehensiveData> get _allData => List.generate(
        50,
        (index) => ComprehensiveData(
          key: '${index + 1}',
          name: 'Employee ${index + 1}',
          age: 22 + (index % 40),
          position: _getPosition(index),
          department: _getDepartment(index),
          salary: 50000 + (index * 2000),
          status: _getStatus(index),
          joinDate:
              DateTime(2020 + (index % 4), (index % 12) + 1, (index % 28) + 1),
        ),
      );

  String _getPosition(int index) {
    final positions = [
      'Developer',
      'Designer',
      'Manager',
      'Analyst',
      'Tester',
      'Architect'
    ];
    return positions[index % positions.length];
  }

  String _getDepartment(int index) {
    final departments = [
      'Engineering',
      'Design',
      'Marketing',
      'Sales',
      'HR',
      'Finance'
    ];
    return departments[index % departments.length];
  }

  EmployeeStatus _getStatus(int index) {
    final statuses = EmployeeStatus.values;
    return statuses[index % statuses.length];
  }

  void _handleBatchAction(String action) {
    if (_selectedKeys.isEmpty) {
      $message.warning(message: '请先选择要操作的数据');
      return;
    }

    final selectedNames =
        _selectedKeys.map((index) => _allData[index].name).join(', ');

    $message.success(message: '$action 操作: $selectedNames');
  }

  @override
  Widget build(BuildContext context) {
    // return SizedBox();
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        // 批量操作按钮
        Row(
          children: [
            ElevatedButton.icon(
              onPressed: () => _handleBatchAction('批量删除'),
              icon: const Icon(Icons.delete, size: 16),
              label: const Text('批量删除'),
              style: ElevatedButton.styleFrom(
                backgroundColor: Colors.red,
                foregroundColor: Colors.white,
              ),
            ),
            const SizedBox(width: 8),
            ElevatedButton.icon(
              onPressed: () => _handleBatchAction('批量导出'),
              icon: const Icon(Icons.download, size: 16),
              label: const Text('批量导出'),
            ),
            const SizedBox(width: 8),
            ElevatedButton.icon(
              onPressed: () => _handleBatchAction('批量编辑'),
              icon: const Icon(Icons.edit, size: 16),
              label: const Text('批量编辑'),
            ),
            const Spacer(),
            Text('已选择: ${_selectedKeys.length} 项'),
          ],
        ),
        const SizedBox(height: 16),

        // 表格
        TolyTableV1<ComprehensiveData>(
          height: 400,
          bordered: true,
          size: TableSize.middle,
          rowSelection: TableRowSelection<ComprehensiveData>(
            type: RowSelectionType.checkbox,
            onChange: (selectedRowKeys, selectedRows) {
              setState(() => _selectedKeys = selectedRowKeys);
            },
            getCheckboxProps: (record) => CheckboxProps(
              disabled: record.status == EmployeeStatus.inactive,
            ),
          ),
          columns: [
            TableColumn(
              title: 'Name',
              dataIndex: (data) => data.name,
              width: 120,
              render: (data, index) => Text(
                data.name,
                style: const TextStyle(
                  color: Colors.blue,
                  decoration: TextDecoration.underline,
                  fontWeight: FontWeight.w500,
                ),
              ),
            ),
            TableColumn(
              title: 'Age',
              dataIndex: (data) => data.age,
              width: 60,
              align: TextAlign.center,
            ),
            TableColumn(
              title: 'Position',
              dataIndex: (data) => data.position,
              width: 100,
            ),
            TableColumn(
              title: 'Department',
              dataIndex: (data) => data.department,
              width: 100,
            ),
            TableColumn(
              title: 'Salary',
              dataIndex: (data) => data.salary,
              width: 100,
              align: TextAlign.right,
              render: (data, index) => Text(
                '\$${data.salary.toString().replaceAllMapped(
                      RegExp(r'(\d{1,3})(?=(\d{3})+(?!\d))'),
                      (Match m) => '${m[1]},',
                    )}',
                style: const TextStyle(fontWeight: FontWeight.w500),
              ),
            ),
            TableColumn(
              title: 'Status',
              dataIndex: (data) => data.status,
              width: 100,
              render: (data, index) => _buildStatusTag(data.status),
            ),
            TableColumn(
              title: 'Join Date',
              dataIndex: (data) => data.joinDate,
              width: 100,
              render: (data, index) => Text(
                '${data.joinDate.year}-${data.joinDate.month.toString().padLeft(2, '0')}-${data.joinDate.day.toString().padLeft(2, '0')}',
                style: const TextStyle(fontSize: 12),
              ),
            ),
            TableColumn(
              title: 'Action',
              dataIndex: (data) => '',
              width: 120,
              render: (data, index) => Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  GestureDetector(
                    onTap: () => $message.info(message: 'Edit ${data.name}'),
                    child: const Icon(Icons.edit, size: 16, color: Colors.blue),
                  ),
                  const SizedBox(width: 8),
                  GestureDetector(
                    onTap: () => $message.info(message: 'View ${data.name}'),
                    child: const Icon(Icons.visibility,
                        size: 16, color: Colors.green),
                  ),
                  const SizedBox(width: 8),
                  GestureDetector(
                    onTap: () =>
                        $message.warning(message: 'Delete ${data.name}'),
                    child:
                        const Icon(Icons.delete, size: 16, color: Colors.red),
                  ),
                ],
              ),
            ),
          ],
          dataSource: _allData,
          pagination: TablePagination(
            pageSize: _pageSize,
            current: _currentPage,
            total: _allData.length,
            onChange: (page, pageSize) {
              setState(() {
                _currentPage = page;
                _selectedKeys.clear(); // 切换页面时清空选择
              });
            },
          ),
          onRow: (record, index) {
            $message.success(
                message: 'Clicked: ${record.name} (${record.position})');
          },
        ),
      ],
    );
  }

  Widget _buildStatusTag(EmployeeStatus status) {
    Color color;
    String text;

    switch (status) {
      case EmployeeStatus.active:
        color = Colors.green;
        text = 'Active';
        break;
      case EmployeeStatus.inactive:
        color = Colors.grey;
        text = 'Inactive';
        break;
      case EmployeeStatus.pending:
        color = Colors.orange;
        text = 'Pending';
        break;
      case EmployeeStatus.suspended:
        color = Colors.red;
        text = 'Suspended';
        break;
    }

    return TolyTag(
      color: color,
      child: Text(
        text,
        style: const TextStyle(fontSize: 12, color: Colors.white),
      ),
    );
  }
}

enum EmployeeStatus { active, inactive, pending, suspended }

class ComprehensiveData {
  final String key;
  final String name;
  final int age;
  final String position;
  final String department;
  final int salary;
  final EmployeeStatus status;
  final DateTime joinDate;

  const ComprehensiveData({
    required this.key,
    required this.name,
    required this.age,
    required this.position,
    required this.department,
    required this.salary,
    required this.status,
    required this.joinDate,
  });
}
